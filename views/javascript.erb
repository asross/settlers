<%#<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>%>
<script type="text/javascript">

  $(document).ready(function() {
    // Display latest messages first
    chat = document.getElementById('message-area');
    chat.scrollTop = chat.scrollHeight;

    // %w(roll build_settlement build_city build_road trade_in pass_turn move_robber rob_player)
    <% Game::ACTIONS.each do |action| %>
      $(document).on('click', '#<%= action %>', function() {
        $('body').removeClass('hex-select');
        $('body').removeClass('road-select');
        $('body').removeClass('city-select');
        $('body').removeClass('player-select');
        $('body').removeClass('trade-select');
        window.currentAction = '<%= action %>';
        <% case action
           when 'build_settlement', 'build_city' %>
          $('body').addClass('city-select');
        <% when 'build_road' %>
          $('body').addClass('road-select');
        <% when 'move_robber' %>
          $('body').addClass('hex-select');
        <% when 'rob_player' %>
          $('body').addClass('player-select');
        <% when 'trade_in' %>
          $('body').addClass('trade-select');
        <% when 'roll' %>
          performAction('roll', []);
        <% when 'pass_turn' %>
          performAction('pass_turn', []);
        <% end %>
      });
    <% end %>

    window.currentAction = null;

    function hex(coords) {
      return $('.hex[data-coords="['+coords[0]+', '+coords[1]+']"]');
    }

    function performAction(action, args) {
      $.ajax({
        url: '/actions',
        type: 'POST',
        data: { color: '<%= @current_player.color %>', data: JSON.stringify({ action: action, args: args }) }
      }).success(function(data, textStatus, jqXHR) {
        window.location.reload(true);
      }).error(function(jqXHR, textStatus, errorThrown) {
        console.log(jqXHR.responseText);
        $('#error').text(jqXHR.responseText);
      });
    }

    $(document).on('mouseenter', '.city-marker, .road-marker', function() {
      coords = $(this).data('coords');
      for (i = 0; i < coords.length; i++) hex(coords[i]).addClass('hover');
    })

    $(document).on('mouseleave', '.city-marker, .road-marker', function () {
      coords = $(this).data('coords');
      for (i = 0; i < coords.length; i++) hex(coords[i]).removeClass('hover');
    });

    $(document).on('click', '.city-marker, .road-marker, .settlement', function() {
      performAction(window.currentAction, $(this).data('coords'));
    });

    $(document).on('click', '#trade-submit', function() {
      resource1 = $('#trade-widget select[name="resource1"]').val();
      resource2 = $('#trade-widget select[name="resource2"]').val();
      performAction('trade_in', [resource1, resource2]);
    });

    $(document).on('click', '.tile, .number', function() {
      if ($('body').hasClass('hex-select')) {
        performAction(window.currentAction, [$(this).closest('.hex').data('coords')]);
      }
    });

    $(document).on('click', '.player .name', function() {
      if ($('body').hasClass('player-select')) {
        performAction(window.currentAction, $(this).closest('.player').data('color'));
      }
    });

    ws = new WebSocket('ws://' + location.hostname + ':8080');

    ws.onmessage = function(evt) {
      response = JSON.parse(evt.data);
      event = response[0];
      data = response[1];
      if (event == 'action') {
        $('#board').html(data.html);
      } else if (event == 'message') {
        $('#message-area').html(data.html);
      }
    }
  });
</script>
