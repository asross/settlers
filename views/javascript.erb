<%#<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>%>
<script type="text/javascript">

  $(document).ready(function() {
    // Display latest messages first

    function fixChatHeight() {
      chat = document.getElementById('message-area');
      chatTop = $(chat).offset().top;
      playersHeight = $('#players').height();
      $(chat).css('height', playersHeight - chatTop - 32);
      chat.scrollTop = chat.scrollHeight;
    }
    fixChatHeight();

    // %w(roll build_settlement build_city build_road trade_in pass_turn move_robber rob_player)
    <% Game::ACTIONS.each do |action| %>
      $(document).on('click', '#<%= action %>', function() {
        <% %w(hex road city player trade monopoly year-of-plenty).each do |type| %>
          $('body').removeClass('<%= type %>-select');
        <% end %>
        window.currentAction = '<%= action %>';
        <% case action
           when 'build_settlement', 'build_city' %>
          $('body').addClass('city-select');
        <% when 'build_road' %>
          $('body').addClass('road-select');
        <% when 'move_robber' %>
          $('body').addClass('hex-select');
        <% when 'rob_player' %>
          $('body').addClass('player-select');
        <% when 'trade_in' %>
          $('body').addClass('trade-select');
        <% when 'discard' %>
          $('body').addClass('discard-select');
        <% when 'monopoly' %>
          $('body').addClass('monopoly-select');
        <% when 'year_of_plenty' %>
          $('body').addClass('year-of-plenty-select');
        <% when *%w(roll pass_turn knight road_building buy_development_card) %>
          performAction('<%= action %>', []);
        <% end %>
        fixChatHeight();
      });
    <% end %>

    window.currentAction = null;

    function hex(coords) {
      return $('.hex[data-coords="['+coords[0]+', '+coords[1]+']"]');
    }

    function performAction(action, args) {
      $.ajax({
        url: '/actions',
        type: 'POST',
        data: { color: '<%= @current_player.color %>', data: JSON.stringify({ action: action, args: args }) }
      }).success(function(data, textStatus, jqXHR) {
        <% if ENV['RELOAD_AFTER_ACTIONS'] %>
          window.location.reload(true);
        <% end %>
      }).error(function(jqXHR, textStatus, errorThrown) {
        console.log(jqXHR.responseText);
        $('#error').text(jqXHR.responseText);
      });
    }

    $(document).on('mouseenter', '.city-marker, .road-marker', function() {
      coords = $(this).data('coords');
      for (i = 0; i < coords.length; i++) hex(coords[i]).addClass('hover');
    })

    $(document).on('mouseleave', '.city-marker, .road-marker', function () {
      coords = $(this).data('coords');
      for (i = 0; i < coords.length; i++) hex(coords[i]).removeClass('hover');
    });

    $(document).on('click', '.city-marker, .road-marker, .settlement', function() {
      performAction(window.currentAction, $(this).data('coords'));
    });

    $(document).on('click', '#trade-submit', function() {
      resource1 = $('select[name="resource1"]:visible').val();
      resource2 = $('select[name="resource2"]:visible').val();
      performAction('trade_in', [resource1, resource2]);
    });

    $(document).on('click', '#monopoly-submit', function() {
      resource = $('select[name="resource"]:visible').val();
      performAction('monopoly', resource);
    });

    $(document).on('click', '#year-of-plenty-submit', function() {
      resource1 = $('select[name="resource1"]:visible').val();
      resource2 = $('select[name="resource2"]:visible').val();
      performAction('year_of_plenty', [resource1, resource2]);
    });

    $(document).on('click', '#discard-submit', function() {
      resources = []
      <% Player::RESOURCE_CARDS.each do |resource| %>
        value = $('input[name="<%= resource %>"]:visible').val();
        if (value)
          for (i = 0; i < parseInt(value); i++)
            resources.push('<%= resource %>')
      <% end %>
      performAction('discard', resources);
    });

    $(document).on('click', '.tile, .number', function() {
      if ($('body').hasClass('hex-select')) {
        performAction(window.currentAction, [$(this).closest('.hex').data('coords')]);
      }
    });

    $(document).on('click', '.player .name', function() {
      if ($('body').hasClass('player-select')) {
        performAction(window.currentAction, $(this).closest('.player').data('color'));
      }
    });

    ws = new WebSocket('ws://' + location.hostname + ':8080');

    ws.onmessage = function(evt) {
      response = JSON.parse(evt.data);
      event = response[0];
      data = response[1];
      if (event == 'action') {
        $('#board').html(data.html);
        fixChatHeight();
      } else if (event == 'message') {
        $('#message-area').html(data.html);
      }
    }
  });
</script>
